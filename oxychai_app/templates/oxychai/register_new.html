{% extends "oxychai/layout.html" %}

{% block title %}Register new patient{% endblock %}

{% block head %}
        <script>
            window.addEventListener('DOMContentLoaded', ()=> {
                
                const Styles = {
                    buttonCorner: 'rounded-sm',
                    //textNormal: 'text-xs font-normal',
                    textNormal: 'text-xl font-normal',
                    //textSemi: 'text-xs font-semibold',
                    textSemi: 'text-xl font-semibold',
                    textColor: 'text-gray-900',
                    textWarning: 'text-red-500',
                    textBold: 'text-xl font-bold',
                    //textBold: 'text-xs font-bold',
                    textTitle: 'text-3xl font-bold',
                    textTitleSmall: 'text-2xl font-semibold',
                    selectCorner: 'rounded-md',
                    HierArchOne: 'text-3xl font-extrabold',
                    HierArchTwo: 'text-2xl font-semibold',
                    HierArchThree: 'text-xl font-medium',
                    //HierArchThree: 'text-xs font-medium',
                }
                const Page = {
                    Layer1: 'bg-stone-600',
                    Layer2: 'bg-stone-500',
                    Layer3: 'bg-stone-300'
                }
                const oxyBlue = 'bg-[#70C4D7]'
                const oxySecondry = 'bg-[#70C4D761]'
                const oxyTertiary = 'bg-[#70C4D733]'
                const oxyColorOutline = 'outline-[#70C4D7]'
                /*const OxyButton = function(text, extra_classes){
                    const button = document.createElement('div')
                    button.setAttribute('class', `${Styles.textSemi} ${Styles.textColor} ${Styles.buttonCorner} pt-6 pb-6 ${extra_classes}`)
                    button.innerHTML = text
                    return button
                }*/
                document.getElementsByTagName('body')[0].setAttribute('class', `${Styles.textColor} ${Styles.textNormal} bg-gray-700`);
                //title
                const titles = document.querySelectorAll('.text_title');
                console.log(titles)
                titles.forEach( (title) => {
                    const existing_classes = title.getAttribute('class');
                    title.setAttribute('class', `${existing_classes} ${Styles.textTitle}`);
                });
                //title small
                const title_smalls = document.querySelectorAll('.text_title_sm'); 
                title_smalls.forEach( (title) => {
                    const existing_classes = title.getAttribute('class');
                    title.setAttribute('class', `${existing_classes} ${Styles.textTitleSmall} my-8 py-2 sticky top-0 bg-gray-50`);
                });
                //text semi
                const text_semi = document.querySelectorAll('.text_semi');
                text_semi.forEach( (text) => {
                    const existing_classes = text.getAttribute('class');
                    text.setAttribute('class', `${existing_classes} ${Styles.textSemi}`);
                });
                //inputs
                const inputs = document.querySelectorAll('.input');
                inputs.forEach((input) => {
                    input.setAttribute('class', `${Styles.textNormal} ${Styles.textColor} w-full pt-[12px] pb-[12px] pl-3.5 border border-gray-300 bg-gray-200 border-2 rounded-md onfocus:outline ${oxyColorOutline} outline-offset-4`);
                });
                //note
                const existing_classes = document.getElementsByTagName('textarea')[0]?.classList
                document.getElementsByTagName('textarea')[0]?.setAttribute('class', `${existing_classes} ${Styles.textNormal} ${Styles.textColor} w-full p-2 bg-gray-200 border border-gray-300 border-2 rounded-md onfocus:outline ${oxyColorOutline} outline-offset-4 h-32`);
                //select
                const selects = document.querySelectorAll('.select');
                selects.forEach((select) => {
                    select.setAttribute('class', `${Styles.textNormal} ${Styles.textColor} pt-[8px] pb-[8px] pl-2 bg-white outline ${oxyColorOutline} rounded-xs`);
                }); 
                //submit
                document.getElementById('register').setAttribute('class', `${Styles.textSemi} ${Styles.textColor} ${Styles.buttonCorner} pt-[10px] pb-[10px] w-full ${oxyBlue}`);
                
                function s_response(message){
                    document.getElementById("server_response").innerHTML = message;
                    document.getElementById("server_response").classList.remove('hidden');
                }
                function convert_cost_to_pennys(amount){
                    //i.e if there s a decimal point
                    if(amount.search(/\./) > 1){
                        const decimal_index = amount.search(/\./)
                        const pounds = amount.substring(0, decimal_index)
                        const pennys = amount.substring(decimal_index + 1)
                        if(pennys.length >= 2){
                            return parseInt(pounds + pennys.substring(0, 2))
                        }
                        else if(pennys.length === 1){
                            return parseInt(pounds + pennys + '0')
                        }
                        else{
                            return parseInt(pounds + '00')
                        }
                    }
                    else{
                        return parseInt(amount) * 100
                    }
                }

                function capitalize_name(name){
                    let name_c
                    name_split = name.match(/[a-zA-Z'-]+/g);
                    console.log(name_split)
                    for(let i = 0; i < name_split.length; i++){
                        //capitalize first letters
                        let capitlised = name_split[i].charAt(0).toUpperCase() + String(name_split[i]).slice(1);
                        if(name_c){
                            name_c = name_c + ' ' + capitlised
                        }
                        else{
                            name_c = capitlised
                        }
                    }
                    name_c = name_c.trim()
                    return name_c
                }
                function get_data(){
                    let first_name
                    let last_name
                    let name = document.getElementById("name").value;
                    if(!name){
                        return false;
                    }
                    let name_c
                    if(name){
                        name = name.trim();
                        //capitalize first letters
                        if(name){
                            name = capitalize_name(name)
                        }
                        console.log('->', name)
                        if(name.includes(" ")){
                            first_name = name.substring(0, name.indexOf(" ")).trim();
                            last_name = name.substring(name.indexOf(" ")).trim();
                        }
                        else {
                            first_name = name;
                            last_name = null;
                        }
                    }
                    else {
                        first_name = null;
                        last_name = null;
                    }
                    //gender
                    let gender
                    document.querySelectorAll('.gender').forEach( (radio) => {
                        if(radio.checked){
                            gender = radio.value;
                        }
                    });
                    if(!gender){
                        gender = null;
                    }
                    //age
                    let age
                    if(document.getElementById("age").value){
                        age = document.getElementById("age").value;
                    } else {
                        age = null;
                    }

                    let req_sessions
                    if(document.getElementById('sessions').value){
                        req_sessions = document.getElementById('sessions').value;
                    }
                    else{
                        req_sessions = null
                    }

                    let email
                    if(document.getElementById("email").value){
                        email = document.getElementById("email").value;
                    } else {
                        email = null;
                    }

                    let phone
                    if(document.getElementById("phone").value){
                        phone = document.getElementById("phone").value;
                    } else {
                        phone = null;
                    }
                    let cost
                    if(document.getElementById("price").value){
                        cost = document.getElementById("price").value;
                        cost = convert_cost_to_pennys(cost);
                    } else {
                        cost = null;
                    }

                    let depth
                    document.querySelectorAll('.depth').forEach( (radio) => {
                        if(radio.checked){
                            depth = radio.value;
                        }
                    });
                    if(!depth){
                        depth = null;
                    }

                    let mask
                    document.querySelectorAll('.mask').forEach( (radio) => {
                        if(radio.checked){
                            mask = radio.value;
                        }
                    });
                    if(!mask){
                        mask = null;
                    }

                    let pipe_length
                    document.querySelectorAll('.pipe_length').forEach( (radio) => {
                        if(radio.checked){
                            pipe_length = radio.value;
                        }
                    });
                    if(!pipe_length){
                        pipe_length = null;
                    }

                    let size
                    document.querySelectorAll('.size').forEach( (radio) => {
                        if(radio.checked){
                            size = radio.value
                        }
                    })
                    // Check hood size select if no radio button size is selected
                    if(!size){
                        const hoodSelect = document.getElementById("hood_size");
                        if(hoodSelect && hoodSelect.value){
                            size = hoodSelect.value;
                        }
                    }
                    if(!size){
                        size = null;
                    }

                    let note
                    if(document.getElementById("note").value){
                        note = document.getElementById("note").value;
                    } else {
                        note = null;
                    }
                    let carer;
                    if(document.getElementById("carer").checked){
                        carer = true;
                    } else {
                        carer = null;
                    }
                    let extras = [];
                    document.querySelectorAll('.extras:checked').forEach((checkbox) => {
                        extras.push(checkbox.value);
                    });
                    if(extras.length === 0){
                        extras = null;
                    }
                    return {
                        'first_name':first_name,
                        'last_name':last_name,
                        'gender':gender,
                        'age':age,
                        'req_sessions':req_sessions,
                        'email':email,
                        'phone':phone,
                        'cost':cost,
                        'depth':depth,
                        'mask':mask,
                        'pipe_length':pipe_length,
                        'size':size,
                        'note':note,
                        'carer':carer,
                        'extras':extras
                    }
                }

                    // Collect form data
                document.getElementById("register").addEventListener('click', function() {

                    const csrf = document.getElementsByName("csrfmiddlewaretoken")[0]?.value;
                    let data = get_data();
                    if(!data){
                        s_response('Name is required');
                        return;
                    }
                    // Send data to the server
                    fetch('/registerNew/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify(data)
                    })
                    .then(response => {
                        console.log(response)
                        if (response.ok) {
                            s_response('Registration successful.');
                            // Optionally, redirect or clear the form
                            //refresh the page after 1 second
                            setTimeout(() => {
                                window.location.href = '/registerNew/';
                            }, 500);
                            
                        } else {
                            s_response('Registration failed.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        s_response('An error occurred.');
                    });
                });
                /*var form = document.getElementById("form_one");
                document.getElementById("back_arrow").addEventListener("click", function () {
                    form.submit();
                });*/

                // Breathing Apparatus Size Management
                // This manages which sizing section is enabled based on the selected breathing apparatus
                
                // Get all sizing section containers
                const maskSizesContainer = document.getElementById('mask-sizes-container');
                const hoodSizesContainer = document.getElementById('hood-sizes-container');
                const tracheaSizesContainer = document.getElementById('trachea-sizes-container');
                
                // Function to disable all size inputs in a container
                function disableContainer(container) {
                    if (!container) return;
                    const inputs = container.querySelectorAll('input, select');
                    inputs.forEach(input => {
                        input.disabled = true;
                        input.checked = false;
                        input.classList.add('opacity-50', 'cursor-not-allowed');
                        if (input.tagName === 'SELECT') {
                            input.value = '';
                        }
                    });
                    // Also gray out the labels for individual options
                    const labels = container.querySelectorAll('label');
                    labels.forEach(label => {
                        label.classList.add('opacity-50', 'cursor-not-allowed');
                    });
                }
                
                // Function to enable all size inputs in a container
                function enableContainer(container) {
                    if (!container) return;
                    const inputs = container.querySelectorAll('input, select');
                    inputs.forEach(input => {
                        input.disabled = false;
                        input.classList.remove('opacity-50', 'cursor-not-allowed');
                    });
                    // Remove gray from labels
                    const labels = container.querySelectorAll('label');
                    labels.forEach(label => {
                        label.classList.remove('opacity-50', 'cursor-not-allowed');
                    });
                }
                
                // Function to update size availability based on selected breathing apparatus
                function updateSizeAvailability(maskId) {
                    // Disable all containers first
                    disableContainer(maskSizesContainer);
                    disableContainer(hoodSizesContainer);
                    disableContainer(tracheaSizesContainer);
                    
                    // Enable the appropriate container based on mask ID
                    // 1: Mask - enable mask sizes
                    // 2: Hood - enable hood sizes
                    // 3: Mouthpiece - no sizes needed
                    // 4: Trachea mask - enable trachea sizes
                    
                    if (maskId === '1') {
                        enableContainer(maskSizesContainer);
                    } else if (maskId === '2') {
                        enableContainer(hoodSizesContainer);
                    } else if (maskId === '4') {
                        enableContainer(tracheaSizesContainer);
                    }
                    // For Mouthpiece (3), all containers remain disabled
                }
                
                // Add event listeners to all breathing apparatus radio buttons
                const maskRadios = document.querySelectorAll('.mask');
                maskRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.checked) {
                            updateSizeAvailability(this.value);
                        }
                    });
                });
                
                // Initialize: disable all size sections on page load
                disableContainer(maskSizesContainer);
                disableContainer(hoodSizesContainer);
                disableContainer(tracheaSizesContainer);
                
            });
        </script>  
{% endblock %}

{% block content %}
    <!--<body data-theme="light" class="bg-gray-900">
        {% csrf_token %}
        <div class="w-[404px] bg-gray-400 m-auto">
            <div class="w-full flex justify-between items-center pt-4 pb-4 pr-2 pl-2 bg-gray-50">
                <div>
                    <img src='/static/oxychai-logo-no-bg.png' alt="oxychai logo" width="80">
                </div>
                <div class="text-gray-100 flex gap-2 text-xs">
                    <a href="/">Calendar</a>
                    <a href="/registerNew">Register</a>
                    <a href="/searchPatients">Search</a>
                    <a>SignIn</a>
                </div>
            </div>-->
            <!--<form action="/" id="form_one" method="get">
                <div id="back_arrow" type="submit" class="p-2 rounded-full shadow-xs shadow-gray-300 absolute top-3 left-3 bg-white" ><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" /></svg></div>
            </form>-->
                    <div class="my-px bg-gray-50old bg-white px-4">
                        <div class="text text_title text-center pt-12 w-">Register patient</div>
                        <div class="">
                            <div class="text_title_sm  text-center z-10">Personal details</div>
                            <div class="">
                                <div class="mb-8">
                                    <div class="mb-3 text_semi">Name</div>
                                    <input type="text" id="name" class="input" autocomplete="do-not-autofill" autocomplete="false" placeholder="John Doe"/>
                                </div>
                                <div class="mb-8">
                                    <div class="text_semi mb-3 ">Gender</div>
                                    <div class="grid gap-3">
                                        <div class="flex gap-0.5">
                                            <input class="gender peer" type="radio" name="gender" value="male" id="gender-male">
                                            <label for="gender-male" class="text">Male</label>
                                        </div>
                                        <div class="flex gap-0.5">
                                            <input class="gender peer" type="radio" name="gender" value="female" id="gender-female">
                                            <label for="gender-female" class="text">Female</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-8">
                                    <div class="mb-3 text_semi">Age</div>
                                    <input type="number" id="age" class="input" autocomplete="do-not-autofill" placeholder="1"/>
                                </div>
                                <div class="mb-8">
                                    <div class="mb-3 text_semi">Carer</div>
                                    <div class="flex gap-0.5">
                                        <input type="checkbox" class="peer" id="carer">
                                        <label for="carer" class="">This person has a carer.</label>
                                    </div>
                                </div>
                                <div class="mb-8">
                                    <div class="mb-3 text_semi">Required Sessions</div>
                                    <input type="number" id="sessions" class="input" autocomplete="do-not-autofill" placeholder="1"/>
                                </div>
                                <div class="mb-8">
                                    <div class="mb-3 text_semi">Email</div>
                                    <input type="text" id="email" class="input" autocomplete="do-not-autofill" placeholder="john@example.com"/>
                                </div>
                                <div class="mb-8">
                                    <div class="mb-3 text_semi">Phone</div>
                                    <input type="number" id="phone" class="input" autocomplete="do-not-autofill" placeholder="phonenumber"/>
                                </div>
                                <div class="mb-8">
                                    <div class="mb-3 text_semi">Price</div>
                                    <input type="number" id="price" class="input" autocomplete="do-not-autofill" placeholder="0.00"/>
                                </div>
                                <div class="mb-8">
                                    <div class="text_semi mb-3">Note</div>
                                    <textarea maxlength="500" id="note" class="note w-full h-32" placeholder="Add note..."></textarea>
                                </div>
                            </div>
                        </div>
                        <!--<div class="mt-12 h-16 w-full bg-gray-100"></div>-->
                        <div class="">
                            <div class="text_title_sm text-center z-10">Appointment requirements</div>
                            <div class="">
                                <div class="mb-8">
                                    <div class="text_semi mb-3 ">Depth</div>
                                    <div class="grid gap-3 ">
                                        {% for depth in depths %}
                                            <div class="flex gap-0.5">
                                                <input class="depth peer" type="radio" name="depth" value="{{ depth.id }}" id="depth-{{ depth.id }}">
                                                <label for="depth-{{ depth.id }}" class="text">{{ depth.depth }}msw</label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="mb-8">
                                    <div class="text_semi mb-3">Breathing Apparatus</div>
                                    <div class="grid gap-3">
                                        {% for mask in masks %}
                                            <div class="flex gap-0.5">
                                                <input class="mask peer" type="radio" name="mask" value="{{ mask.id }}" id="mask-{{ mask.id }}">
                                                <label for="mask-{{ mask.id }}" class="text">{{ mask.mask }}</label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="mb-8">
                                    <div class="text_semi mb-3">Pipe Length</div>
                                    <div class="grid gap-3">
                                        {% for len in pipe_lengths %}
                                            <div class="flex gap-0.5">
                                                <input class="pipe_length peer" type="radio" name="pipe_length" value="{{ len.id }}" id="pipe_length-{{ len.id }}">
                                                <label for="pipe_length-{{ len.id }}" class="text">{{ len.length }}</label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="mb-8">
                                    <div class="text_semi mb-4">Sizing</div>
                                </div>
                                <div class="mb-8 pl-3" id="mask-sizes-container">
                                    <div class="text_semi mb-3">Mask Sizes</div>
                                    <div class="grid gap-3">
                                        {% for size in mask_sizes %}
                                            <div class="flex gap-0.5">
                                                <input class="size peer" type="radio" name="size" value="{{ size.id }}" id="size-{{ size.id }}">
                                                <label for="size-{{ size.id }}" class="text">{{ size.size_full }}</label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="mb-8 pl-3" id="hood-sizes-container">
                                    <div class="text_semi mb-3">Hood Sizes</div>
                                    <select id="hood_size" class="select">
                                        <option value="">Select hood size</option>
                                        {% for size in hood_sizes %}
                                            <option value="{{ size.id }}">{{ size.size }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="h- mb-8 pl-3" id="trachea-sizes-container">
                                    <div class="text_semi mb-3">Trachea Sizes</div>
                                    <div class="grid gap-3">
                                        {% for size in trachea_sizes %}
                                            <div class="flex gap-0.5">
                                                <input class="size peer" type="radio" name="size" value="{{ size.id }}" id="sizeT-{{ size.id }}">
                                                <label for="sizeT-{{ size.id }}" class="text">{{ size.size }}</label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="mb-8">
                                    <div class="text_semi mb-3">Items</div>
                                    <div class="grid gap-3">
                                        {% for ex in extras %}
                                            <div class="flex gap-0.5">
                                                <input class="extras peer" type="checkbox" name="extras" value="{{ ex.id }}" id="extras-{{ ex.id }}">
                                                <label for="extras-{{ ex.id }}" class="text">{{ ex.item }}</label>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="pt-8 pb-10">
                            <div id="server_response" class="mb-2 bg-gray-400 w-full pt-1 pb-1 pr-3 pl-3 hidden"></div>
                            <div><button id="register" class="">Register</button></div>
                        </div>
                    </div>
 
    {% endblock %}